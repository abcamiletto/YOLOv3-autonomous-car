{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Obstacle detection on Berkeley Deep Drive Dataset\n",
    "This will be an implementation of a Yolo v2-v3 on the recent dataset published by Berkley for autonomous driving. The various comment will guide you into the code, but for a more general understanding of the project i suggest to read the README.md\n",
    "\n",
    "## Importing the main libraries"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Utility libraries\n",
    "import os\n",
    "import random\n",
    "import matplotlib.pyplot as plt\n",
    "\n",
    "# Core libraries\n",
    "import numpy as np\n",
    "import tensorflow as tf\n",
    "\n",
    "from tensorflow import keras\n",
    "from tensorflow.keras.models import Sequential\n",
    "# from tensorflow.keras.layers import Dense, Softmax\n",
    "# from tensorflow.keras import regularizers\n",
    "# from tensorflow.keras import metrics\n",
    "# from tensorflow.keras import losses\n",
    "# from tensorflow.keras import optimizers\n",
    "from tensorflow.keras.callbacks import TensorBoard\n",
    "from tensorflow.keras.layers import Conv2D, LeakyReLU, Add, BatchNormalization, GlobalAveragePooling2D, Dense, Softmax\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Load the TensorBoard notebook extension (for visualization purposes)\n",
    "%load_ext tensorboard"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Model designing"
   ]
  },
  {
   "attachments": {
    "residual.jpg": {
     "image/jpeg": "/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCACwARMDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD3+iiigBKaevanE8daxrjxRpFrO8Et0BIjbWXYeD+VOMW9kVCnOo7QTfobNFYX/CX6J/z+D/vhv8KX/hL9E/5/B/3w3+FP2U+zNfqtf+R/czcorD/4S/RP+fwf98N/hR/wl+if8/g/74b/AAo9lPsw+q1/5H9zNyisP/hL9E/5/B/3w3+FH/CX6J/z+D/vhv8ACj2U+zD6rX/kf3M3KKw/+Ev0T/n8H/fDf4Uf8Jfon/P4P++G/wAKPZT7MPqtf+R/czcorD/4S/RP+fwf98N/hR/wl+if8/g/74b/AAo9lPsw+q1/5H9zNyisP/hL9E/5/B/3w3+FH/CX6J/z+D/vhv8ACj2U+zD6rX/kf3M3KKw/+Ev0T/n8H/fDf4Uf8Jfon/P4P++G/wAKPZT7MPqtf+R/czcorD/4S/RP+fwf98N/hR/wl+if8/g/74b/AAo9lPsw+q1/5H9zNyisP/hL9E/5/B/3w3+FH/CX6J/z+D/vhv8ACj2U+zD6rX/kf3M3KKw/+Ev0T/n8H/fDf4Uf8Jfon/P4P++G/wAKPZT7MPqtf+R/czcorD/4S/RP+fwf98N/hR/wl+if8/g/74b/AAo9lPsw+q1/5H9zNyisP/hL9E/5/B/3w3+FH/CX6J/z+D/vhv8ACj2U+zD6rX/kf3M3KKw/+Ev0T/n8H/fDf4Uf8Jfon/P4P++G/wAKPZT7MPqtf+R/czbGKWsOLxXo80qxJdgu7BVGw8k9O1bYIIyDRKLjujOdKdP44teo6iiipICiiigAooooATvXj/iD/kYb/wD66mvYO9eP+If+Rhv/APrqa7MH8T9D28j/AI0vT9TNooor0D6gKKKKACiiigAooooAKKKKACiiigDL1jVG0w2OFQrcXKwuXONoOef0q79ttf8An5h/7+Cua8aTWTPpVrdyx7Tdo8iM2P3eCCT7Vop4U0CVFdNOiKsMghjyPzrHmk5NI4VVqurOMLNK278vRmp9ttf+fmH/AL+Cj7ba/wDPzD/38FZn/CJ6D/0DovzP+NH/AAieg/8AQOi/M/41d59l/XyNL4jsvvf+Rp/bbX/n5h/7+Cj7ba/8/MP/AH8FZn/CJ6D/ANA6L8z/AI0f8InoP/QOi/M/40Xn2X9fIL4jsvvf+Rp/bbX/AJ+Yf+/go+22v/PzD/38FZn/AAieg/8AQOi/M/40f8InoP8A0DovzP8AjRefZf18gviOy+9/5Gn9ttf+fmH/AL+Cj7ba/wDPzD/38FZn/CJ6D/0DovzP+NH/AAieg/8AQOi/M/40Xn2X9fIL4jsvvf8Akaf221/5+Yf+/go+22v/AD8w/wDfwVmf8InoP/QOi/M/40f8InoP/QOi/M/40Xn2X9fIL4jsvvf+RqrdW7sFS4iZj0AcEmpa4/WdF07TLzR5bK1WF2vkUsCeRnpXYUQk22mVRqTlKUZqzXb+kWtL/wCQrZ/9d0/9CFezjoK8Y0v/AJCtn/13T/0IV7OOgrjxm6PBz3+JD0HUUUVxHhBRRRQAUUUUAJ3rx/xD/wAjDf8A/XU17B3rx/xD/wAjDf8A/XU12YP4n6Ht5F/Gl6fqZtFFFeifTvYyDroDEfZmOCR96k/t4f8APs3/AH3WQfvN/vH+dJXesPBo+Onm+KUmub8EbH9vD/n2b/vuj+3h/wA+zf8AfdZKRvISERnIGTtGcD1ptH1emR/bGL/m/BGx/bw/59m/77o/t4f8+zf991j07y38vzNjeXnG7HGfTNHsKYf2xi/5vwRrf28P+fZv++6P7eH/AD7N/wB91j0U/q9MP7Xxf834I2P7eH/Ps3/fdH9vD/n2b/vuseij6vTD+18X/N+CHa0trrclm81sQbeQMfmHzL3X+Vaw11QMC1IH+8Kx6KlYWmm3YiOaYmMnJPV76I2P7eH/AD7N/wB90f28P+fZv++6x6Kr6vTL/tfF/wA34I2P7eH/AD7N/wB90f28P+fZv++6x6KPq9MP7Yxf834I2P7eH/Ps3/fdH9vD/n2b/vuserlhpl1qbzrbKp8iFppCzYCqOpzSdGnFXYf2vi/5vwRc/t4f8+zf990f28P+fZv++6yUjeTOxGbaMnaM4HqabR9Xph/bGL/m/BGx/bw/59m/77q/Y3gvYmkClNrbcE5/z1rmK3ND/wCPSX/rqf5Csq1KMI3R6OV5jXxFfkqO6s+iKXij/X6L/wBhCOuhrnvFH+v0X/sIR10NcEPike3R/i1Pl+Ra0v8A5Ctn/wBd0/8AQhXs46CvGNL/AOQrZ/8AXdP/AEIV7OOgrkxm6PCz3+JD0HUUUVxHhBRRRQAUUUUAJ3rx/wAQ/wDIw3//AF1Newd68f8AEP8AyMN//wBdTXZg/ifoe3kX8aXp+pm0UUV6J9O9jkD95v8AeP8AOkpT95v94/zpK9WOyPzup8bO58Gasz299pkVtBDEunzPLIq5eVgOCT6DPQVzvh7SINcu5LJrkwXTRE2wIG2Rx/CT2zW14Ri06xE95da1Ywm5tJYBC27ejNwM8Y7VS0eDS9H1uS7u9St7qOxQTQiAt+/k/hUZHY9a4b8s6nJe/p1IK2paGui6dZS3rsNQuGLm0IxsiHdj1BJrbvtVfVfh3Oxt4LaGG/jSKGBcKi7CfxPuaoeJNQs/ENpZ6sZ44tSP7i7g55x0ce2OtaMVnpSeEZ9IPiLTvOku1uA/z7QAuMfd61Mm3GMpr3r9ttQOH611d1oOg6Q0VjquoXiai8QkkMMYaKEsMgHufwrl/wDVS/Kwba3BHQ4NdnrlrpfiS/XWU1uztYpok8+KYnzY2VQCAoHzdK6K8mprVpa7fgBmWuiaXaaNBqmtXVyqXbsttDaqCzKpwWJboKml8KQNrekQW148mnaphoZymHUdwR0yKmIsfEPhrTbQana2V5p2+MrdMUWRCchgfX2q0NY0601zw3ZRXiS2mln99c4IVmY5JHsK53Uq3dm766ffb9AKsfhjR7qa+02z1G5l1S1jeTcYwIXK9VHf8ax7/RVt9G0vUbaVpkvAyOpXHlyA4K1q6Bqlla+L9Ru57hUt5Y7gJIc4JbOPzqbwdqulpp81hrUwjhguEvbfcM5deq/jxVOVaF3q0rfje4GF4h0mPRNSWxWcyyrCjTZGNjkZKj6cVRs7Sa/vIbS3TfNM4RF9Sa17q0fVtM1LxLc3GxzdBFiK/wCsLc8H2FJ4Qv7XTfFFldXjhIVLAueiEqQD+ZreNSSpN7yX52At2/hizvtRuNKsr2SW/gUs8hUCFiCAwHfjPX2rC1OC0ttSngsbhri3jbasrDG/HU49M11Gk/2bpz6tbNqts97dW0iJchiIkyRxuxySM/lWJpGhx6rf3kC3qpb2sDzG42HaQvTg9M1nTqtNuTdl5CMeuot/+JR4BuJ+lxq83kp6+SnLH8TxXN28El1cRQRLuklcIo9STgV0HjSeNNVh0q3bNvpkK2y46Fhy5/P+Va1felGHz+7/AINhmt4R1ZptJ1XTY7WCGKPTZXd0X55X/vMfx6Vwtdn4Uj02xtL2e61uxie9s3gETbt0bN/e49u1cne20dpdPDFcw3KLjEsOdrcdsgGs6FlWmkBBW5of/HpL/wBdT/IVh1uaH/x6S/8AXU/yFXifgPXyT/efkyl4o/1+i/8AYQj/AK10Ncl4x1O3tLvSI5t6mO6Wc4QkbBkHHv7V1aOJI1cAgMAQCMGvLg1zyR9NRlF1qiT7fkXNL/5Ctn/13T/0IV7OOgrxjS/+QrZ/9d0/9CFezjoK5cZujxM9/iQ9B1FFFcR4QUUUUAFFFFACd68f8Q/8jDf/APXU17B3rx/xD/yMN/8A9dTXZg/ifoe3kX8aXp+pm0UUV6B9Ozj2Zd7fMPvHv70m5f7w/Ouu8mI/8sk/75FHkRf88k/75FdaxVlax85PIZN35/w/4JyO5f7w/Ojcv94fnXXeRF/zyT/vkUeRF/zyT/vkU/rXkT/YEv5/w/4JyO5f7w/Ojcv94fnXXeRF/wA8k/75FHkRf88k/wC+RR9a8g/sCX8/4f8ABOR3L/eH50bl/vD8667yIv8Ankn/AHyKPIi/55J/3yKPrXkH9gS/n/D/AIJyO5f7w/Ojcv8AeH5113kRf88k/wC+RR5EX/PJP++RR9a8g/sCX8/4f8E5Hev94fnRuX+8Pzq94oiRX0cKijdqEYOB1610Hkxf88k/75FSsZdtWM45JKU5R59rdP8AgnMy6jPNYwWTzA28BZo4xgAE9T7mq+5f7w/Ouu8iL/nkn/fIo8iL/nkn/fIprEpbRNP7Al/P+H/BOR3L/eH51Yh1Ge3s7i0imCQ3G3zQMZYDkDPXHtXTeRF/zyT/AL5FHkRf88k/75FDxKe8Q/sCX8/4f8E5a1vJLO6jubeby5om3I4IyD60yWczSvLLJvkdizMTySeprrPIi/55J/3yKPIi/wCeSf8AfIo+sK97B/YEv5/w/wCCcjuX+8Pzo3L/AHh+ddd5EX/PJP8AvkUeRF/zyT/vkU/rXkH9gS/n/D/gnI7l/vD862NLuYrbTZZZG+XzSBjqTgcCtbyIv+eSf98isnV41+0WsZIjiJOSBwDkc/lSdX2rUWrDWBnl0ZYhS5mlbbv8ytd21x4gKTx6a0sdg4mJUFtoH97Hb/CtKx1VLpxFIvlynpzkN9K7rwno2kWmma3HZ69FdxzQbZnWIjyRhuTzz1P5V53rGnafp13arpmrJqG4glkjK7DkYFYQlTnOUYq1vJ9upw4bM68a3M3e++x0ml/8hWz/AOu6f+hCvZx0FeMaX/yFbP8A67p/6EK9nHQV5mM3R2Z58cPQdRRRXEeGFFFFABRRRQAnevH/ABD/AMjDf/8AXU17B3rx/wAQ/wDIw3//AF1NdmD+J+h7eRfxpen6mbRRRXoH072Kh1SyBIM65HHQ0n9q2X/Pwv5GucP3m/3j/OkrtWGi1e58tPPaybXKvx/zOk/tWy/5+F/I0f2rZf8APwv5Gubop/VY9yf7erfyr8f8zpP7Vsv+fhfyNH9q2X/Pwv5Guboo+qx7h/b1b+Vfj/mdJ/atl/z8L+Ro/tWy/wCfhfyNc3RR9Vj3D+3q38q/H/M6T+1bL/n4X8jR/atl/wA/C/ka5uij6rHuH9vVv5V+P+YzxXbJq1xYSWt66bJQJNpYBV/vj3HP510sepWMcaoLgEKAATkmudoqFgoJt33MoZxVhOU1FXl6/wCZ0n9q2X/Pwv5Gj+1bL/n4X8jXN0Vf1WPc1/t6v/Kvx/zOk/tWy/5+F/I0f2rZf8/C/ka5uij6rHuH9vVv5V+P+Z0n9q2X/Pwv5Gj+1bL/AJ+F/I1zdOSN5CQiMxAzhRnij6rHuH9vVv5V+P8AmdF/atl/z8L+Ro/tWy/5+F/I1zdFH1WPcP7er/yr8f8AM6T+1bL/AJ+F/I0si22qWxCvuUHhh1U1zVbmh/8AHpL/ANdT/IVnVoqmuZM7MFmM8ZU9jVirNMLfWbzwlDNZxxwTJqzC13NnKkg8/qfWlsdJFvIJZmDyD7oHRao+KBmfRf8AsIR10NcsajcpL0OnDZdQhXlJLa1vuLWl/wDIVs/+u6f+hCvZx0FeMaX/AMhWz/67p/6EK9nHQVwYzdHBnv8AEh6DqKKK4jwgooooAKKKKAE714/4h/5GG/8A+upr2DvXj/iH/kYb/wD66muzB/E/Q9vIv40vT9TNooor0T6d7HIH7zf7x/nSUp+83+8f50lepHZH53U+NnW+HL+2ub3T9LTw5aTxyMsc8jqzyNnq27+HHWqF74fefWNZh0jbNb2LM23f8xQHsO+K1tA/4TDTJLK2tLWdrKYhghiDROjcnLY44PrVu3s7ez+Il/eadKsGmafmW4deVC4+ZB65ORiuBz5JycX07369fPoiDkRps1pZWeqXcCtZzS4RC+1pQvXHcDtmuo0ySx8QadqyXOh2dlb21q0sVzChVo2H3QWJ+bNReLLaXXLrS9Q0td9jdxiC2hGFEDjrH6A55rV0JtevPtlj4mglOkJbuZWuYggjYD5SrYHNKrU5qam9/XVa9ur6AebV0CeDdTa3jkeWzhmlj8yO1lnCyuvqFrDiZEuEZuY1cE+4zXZ+L9D1TVfFL3dhaS3FrcxpJDMgymzaP4ugxXTVqOMlFO176sDC07wxe6hY/bWmtbS1L7FlupRGHb0HrTZvDWpwa3DpLxJ9pnx5RDgo4PQhvStvV7C71fwl4fk0y3kuYreN4ZkhG4pJu7gevrWrGDbeJvBunTsDe2sWJ1zkpnJCn3ArB4moru666drX/r5gcvN4O1SGznnLWrSW6eZNbJMDLGvqVrMvtKutOhtJp1Xy7uLzYWVshl/x9q6TwuxbxLrpJJJs7vJJ61d8LWkPiXw/a2dy6g6TdiZix/5d25YfmKp16lO7lqla/wA/+CBxup6XdaRcpb3iqsrRrJtDZwGGRn0PtVRVLMFUZJOAK2dZF7rdxqHiARE2f2jYXyPlz90Y69MU3wtY/wBo+KNOtiMq06s30Xk/yroVW1LmlutwOjktbrTdYtNH0pEihtRG1/csg2s5AZt7HsAcYrldels5tfvZNPVRaNMTEFGBj29q6zS2ubrxbrdzqEckelMJnu0mBCEchRg8bumO9cdp+mXWq3LwWMJkdUaQrkDCjqea58PZNuT2Sv8APuIp11Gi/wDEq8J6rq54mucWNufry5H4VzABYgKMk8AetdN4tP8AZ8GmaCp/48YA82O8z/M35DArev7zjDv+S/pDLXhmx0G806+ie3lub5LGWdpJOEiI6BR3PfJrjh0rt/A2kaiV1K5+xTeRcadKkUmw4dj0APeuOu7S5sbhre6gkgmUDdHIuCM+1RRkvazV77AQ1uaH/wAekv8A11P8hWHW5of/AB6S/wDXU/yFVifgPXyX/efkyl4o/wBfov8A2EI66Gue8Uf6/Rf+whHXQ15kPikfT0f4tT5fkWtL/wCQrZ/9d0/9CFezjoK8Y0v/AJCtn/13T/0IV7OOgrkxm6PDz3+JD0HUUUVxHhBRRRQAUUUUAJ3rx/xD/wAjDf8A/XU17B3rx/xB/wAjDf8A/XU12YP4n6Ht5F/Gl6fqZtFFFeifTvY5A/eb/eP86St06JbFifMmGTnqP8KP7Dtv+es35j/Cu1YmCVj5GeTYlyb0+8zItTv4IDBFfXMcJ42LKwX8s1XEkioyB2Ct94A8H6+tbf8AYdt/z1m/Mf4Uf2Hbf89ZvzH+FHt6a6E/2JifL7zFEsgQIJHCA7goY4B9cetTz6lf3MIhnvbmWIdEeVmH5E1p/wBh23/PWb8x/hR/Ydt/z1m/Mf4Ue3p9g/sTE+X3mFVldQvUtjbJeXC256xCQhfyzitT+w7b/nrN+Y/wo/sO2/56zfmP8KbxFN7oP7ExPl95lW19d2W77LdTwbuvlSFc/lUXnSmbzvNfzc537juz65ra/sO2/wCes35j/Cj+w7b/AJ6zfmP8KXt6e9g/sTE+X3mIskiMWV2ViCCQSCc9aElkj3eXI6bhhtrEZHoal1y1j01tP8qdgs90kUhcjhSDntxV/wDs/TP+f7/yKtL63Tu0ZLKa7k46XXmRzauzaBBpMMXlRLIZpm3ZMr9AT6ADtU/hvU7fSLq7u5iwm+ySR2+1c/vGGAT6cZpn9n6Z/wA/3/kVaP7P0z/n+/8AIq1Dq0XFx7l/2RiPL7yjLfXk8Qimu55Ix0R5CR+Rq1pertpNpfJBF/pN1H5In3f6tD94Aep4Gak/s/TP+f7/AMirR/Z+mf8AP9/5FWqdak1ZrQX9j4jy+8pafdLY6hb3TQrMIZA/lscBsHODRqF9LqOoXF5Of3s8hdvbParv9n6Z/wA/3/kVaP7P0z/n+/8AIq0e3pX5uof2PiPL7zPS8uo0CR3MyKOirIQBUckjyuXkdnY9WY5Nan9n6Z/z/f8AkVaP7P0z/n+/8irVfWaYf2PiPL7zJrc0P/j0l/66n+QqH+z9M/5/v/Iq1ctGsbOIxx3cZBbcS0i1nWrwnGyPQy3AVMPX9pUta3czPFH+v0X/ALCEddDXNeJJ4ZbnRRHNG5GoR5CsDXS1ww+KR7VFp1alvL8i1pf/ACFbP/run/oQr2cdBXjGl/8AIVs/+u6f+hCvZx0FcmM3R4ee/wASHoOoooriPCCiiigAooooATvXj/iD/kYb/wD66mvYO9eQ+IEc+IL8hGI809q68H8TPbyN2rS9P1MuineW/wDcb8qPLf8AuN+Vejc+m5ojaKd5b/3G/Kjy3/uN+VFw5ojaKd5b/wBxvyo8t/7jflRcOaI2ineW/wDcb8qPLf8AuN+VFw5ojaKd5b/3G/Kjy3/uN+VFw5ojaKd5b/3G/Kjy3/uN+VFw5onFePJpRJpdu1iLiB5w2N2N7DjYfrnrWvH4T0Py1LaXCjkDcAxOD+dbUtos5jMsG8xuHTK/dYd6k8t/7jflWXs48zk9TkWGg6sqk7O9rXS0MP8A4RPQf+gdF+Z/xo/4RPQf+gdF+Z/xrc8t/wC435UeW/8Acb8qfJDsjT2ND+VfcjD/AOET0H/oHRfmf8aP+ET0H/oHRfmf8a3PLf8AuN+VHlv/AHG/Kjkh2Qexofyr7kYf/CJ6D/0DovzP+NH/AAieg/8AQOi/M/41ueW/9xvyo8t/7jflRyQ7IPY0P5V9yMP/AIRPQf8AoHRfmf8AGj/hE9B/6B0X5n/Gtzy3/uN+VHlv/cb8qOSHZB7Gh/KvuRh/8InoP/QNi/M/40f8InoP/QNi/M/41ueW/wDcb8qPLf8AuN+VHJDsg9hQ/lX4GTa+HtIs5hLb2EKuOQTyR9M1qU7y3/uN+VHlv/cb8qpKK2NYRpwVopIsaX/yFbP/AK7p/wChCvZx0FeNaYjjVrMlG/16dv8AaFeyjoK4sZuj5zPHepD0HUUUVxHhhRRRQAUUUUAFN2If4R+VOooAZ5af3F/Kjy0/uL+VPop3Ycwzy0/uL+VZ17rOjabMIb/UbG1lK7gk86IxHrgnpWpXhHxCmsYPjXbS6joE2uWyaNlrSKESH7z/ADYPYetF2HMe3W8ttdwLPbPFNE3KvGwZT9CKm8tP7i/lXgPhbxFL4H+FmqeIbMW5i1PUyunWbSF0tc5GHx6Acj2HrXQeFfiPq9x4jn0ee9sNfD2El1BNYQtFtlQE+UQRznHB+lK4cx66VjVSzKoAGST2qC0urO/txcWk0FxCxIEkTB1OOvIry/wD4z1vxO9y+o6tpEy/Z5TPpIgaKe3YdBz95fX61j6H421Gz+HPhq00HT9OstS1nUZbWFUjIhhAfltpJJPI70XC57AmraZJrcmjJcxHUY4hM8H8QQ8Bq0PLT+4v5V4jo8+u6b8XfEc+tSWk+o22gM6y26FY5Au0qSp6e4rZu/iLrNt8KtA8Sqlob+/u44Zh5Z2BSzA4GeDhR3ouFz1Xy0/uL+VZ97q+l6fqFlYXVzDDdXrFbeJushHUCvO/iD4z1vQNTvBaeJdBsUt4hJBYyxNLcTHbkhscLk8CsrUdbk8SeJPhTrEqLHLdtLI6L0DYUHHtkU7hzHsF5d2Wn25uLyeC2gBAMkzBFBPTk8VFY6ppWqbv7PvrO72/e8iVXx9cGuD+PH/JMLjjP+lQcevzVyHh4W9h8YdEnk8PS+FIprR4YodoK3shB6lflHUfkKVwue06Vq+l63HPJptzDcrBM0EpT+Fx1U1oeWn9xfyrwXwx4ruPCXgfxBc2UEct9deJJLW2ST7u98cn2GK6208T+K/DXjfTND8VXNhfW+qQyPFPaQmMwugyQR3H+NFwuz03y0/uL+VZ+lavpetxzyabcw3KwTNBKU/hcdVNcH4O8QeNfGUsfiC3n0u30F7tohZPExlMKtgtv/ve3SuJ8C+LNQsLq98MaCludY1HXbiQy3QPlQwrjceo3NwcAUXC7Pb7nWtLstZstInnVb+9VmghCElgoyTwOB9a0/LT+4v5V5lpBOofH7W3uG3NpmlRQxeg37WYj06mqg8Y674itvE+vafqaaZo2iGSO2UQq5upEGSXLdFPAwMHnrTuHMz1jy0/uL+VHlp/cX8q434dahr+uaPLr2tzbY9QfzLOzCqBBD25AySevPbFdrRdhzGBrXinQtBuIra/ulW5lUskEUTSyMo6naoJx71AvjXwy+k2mqpqUL2V1cC2imVCV809Fbj5T9cV5Rp+t6ktx498eWdrHdSRXH2GGSVv9RAv3mUfxY+Q4yM1p33hnSbD9ne9/s26e7jliXURcuuxmk3Kc4/hxjGKVw5mez+Wn9xfyo8tP7i/lWX4YvX1HwppF7KcyT2cUjn1JQE1r07sOYbsT+6Pyp1FFIAooooAKKKKACiiigAooooAKKKKACuVl8HiX4jweLjeY8qxNp9m8vrkk7t2ffpiuqooA8wm+ENu2k67paarJHZ316t/ZosXNnKM9OfmBzjHHStnRvD/AIxtnnGreKLWeM2zxRfZ7BUZXIwshPcj07121FAHm+kfDvVV8Vr4g8Qa3b3t3DavbRG2sxDuDAgtIR944Jqs3wke38HaRpVlrLR6lpF413a3ph4DM2SCuenTv2r1GigDz3Rfh3d23iK+1zWtdbUbvULBrO4UQCNQCR9zB4AAxj8awo/g9q0miWuiXniovplhcCeygS1Ax82TvOcngkD0zXr9FAHmerfDLUbvxLrd9p+vrZ2WtxhL2JrVZJBhcYRj0Bq3a/DMW3/CHf8AE0Lf8I5v/wCWOPP3fj8v616DRQBzHjzwn/wmvheTRvtn2QvKkgl8vfjac9MisXT/AIdX7+ItO1nxJ4ln1iXTMmzjFusKIx7kL1PT8q9BooA8zb4SQyeFNT0d9Vk8251NtSt7lYsGCTsMZ57+nWrekeA9Wl8TWuveK9cTVbmyhaG0ihtxEibhhmPqSK9BooA848O+AfEHha+W003xOqeHluzc/Y2tQZcE5Me/PAPrVU/B6IaZKkOrvDqa6o+o2l8kOGgLEZTGeRx616jRQB5nHZXWifG5LqaNpLbW9LETzJGQvnR4zn0yB+tQwfCLytI1XQ28R3P9jXs0k8dqkKqUkYcFmzlgMA44BxXqVFAHnOr6N4l0L4cR6DpF9cXupOYbO2nt4fJFugIBckEkDAOST3rp9ZvH8PeBry7ubgzTWVgzNM3V3VOv4n+db9RyxRzRtHKiujDBVhkH8KAPFPA3gHVNZ+FVrYya8bTTdUY3NzClqDKwLdA+ehCg9DXTfEbTxpHwsTw1ottIxuWh0+2jVSxALDJP4A5PvXoscaRRrHGioijCqowAPpUlAFLSbBdL0ey09DlbaBIQfXaoH9Ku0UUAFFFFABRRRQAUUUUAf//Z"
    }
   },
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Residual Blocks\n",
    "First of all, we need to write down the code for the residual blocks used in the Darknet-53, which is a 53 layer deep feature extracotr used as a backbone for YOLOv3.\n",
    "\n",
    "![residual.jpg](attachment:residual.jpg)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [],
   "source": [
    "class Conv_2D_plus(keras.layers.Layer):\n",
    "    def __init__(self, filters, kernel_size, stride = 1, **kwargs):\n",
    "        super().__init__(**kwargs)\n",
    "        self.filters = filters\n",
    "        self.kernel_size = kernel_size\n",
    "        self.stride = stride\n",
    "    \n",
    "    def call(self, inputs):\n",
    "        X = Conv2D(filters = filters,\n",
    "                   kernel_size = kernel_size,\n",
    "                   strides = stride,\n",
    "                   padding = \"same\",\n",
    "                   use_bias = False)(inputs)\n",
    "        X = BatchNormalization()(X)\n",
    "        X = LeakyReLU(alpha=0.1)(X)\n",
    "        return X\n",
    "\n",
    "\n",
    "class Residual_Block(keras.layers.Layer):\n",
    "    def __init__(self, filters_alpha, filters_beta, **kwargs):\n",
    "        super().__init__(**kwargs)\n",
    "        self.hidden1 = Conv_2D_plus(filters_alpha, 1)\n",
    "        self.hidden2 = Conv_2D_plus(filters_beta, 3)\n",
    "        self.hidden = [self.hidden1, self.hidden2]\n",
    "        \n",
    "    def call(self, inputs):\n",
    "        Z = inputs\n",
    "        skip_Z = inputs\n",
    "        for layer in self.hidden:\n",
    "            Z = layer(Z)\n",
    "        output = Add()([Z, skip_Z])\n",
    "        return output\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Defining the model itself"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "metadata": {},
   "outputs": [],
   "source": [
    "class Darknet53(keras.Model):\n",
    "    def __init__ (self, classification = False, num_classes = None, **kwargs):\n",
    "        super().__init__(**kwargs)\n",
    "        self.num_classes = num_classes\n",
    "        self.classification = classification\n",
    "        self.pre_conv = Conv_2D_plus(32, 3)\n",
    "        self.conv_res = [self.Darknet_res_block(64, 1),\n",
    "                          self.Darknet_res_block(128, 2),\n",
    "                          self.Darknet_res_block(256, 8),\n",
    "                          self.Darknet_res_block(512, 8),\n",
    "                          self.Darknet_res_block(1024, 4)]\n",
    "        if self.classification:\n",
    "            self.out1 = GlobalAveragePooling2D()\n",
    "            self.out2 = Dense(1000)\n",
    "            self.out3 = Dense(self.num_classes)\n",
    "            self.out4 = Softmax()\n",
    "        \n",
    "    def call(self, inputs):\n",
    "        Y = inputs\n",
    "        Y = self.pre_conv(Y)\n",
    "        for res_block in self.conv_res:\n",
    "            for layer in res_block:\n",
    "                Y = layer(Y)\n",
    "        if self.classification:\n",
    "            Y = self.out1(Y)\n",
    "            Y = self.out2(Y)\n",
    "            Y = self.out3(Y)\n",
    "            Y = self.out4(Y)\n",
    "        return Y\n",
    "    \n",
    "    def Darknet_res_block(self, num_filters, num_blocks):\n",
    "        layers = [Conv_2D_plus(num_filters, 3, stride = 2)]\n",
    "        for i in range(num_blocks):\n",
    "            layers.append(Residual_Block(num_filters // 2, num_filters))\n",
    "        return layers\n",
    "\n",
    "    \n",
    "model = Darknet53(classification = True, num_classes = 8)\n",
    "model.compile()"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
